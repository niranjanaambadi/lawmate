// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email                 String    @unique @db.VarChar(255)
  mobile                String?   @unique @db.VarChar(15)
  passwordHash          String    @map("password_hash") @db.VarChar(255)
  khcAdvocateId         String    @unique @map("khc_advocate_id") @db.VarChar(50)
  khcAdvocateName       String    @map("khc_advocate_name") @db.VarChar(255)
  khcEnrollmentNumber   String?   @map("khc_enrollment_number") @db.VarChar(50)
  role                  UserRole  @default(ADVOCATE)
  isActive              Boolean   @default(true) @map("is_active")
  isVerified            Boolean   @default(false) @map("is_verified")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at")
  lastLoginAt           DateTime? @map("last_login_at")
  lastSyncAt            DateTime? @map("last_sync_at")
  preferences           Json      @default("{}") @db.JsonB

  cases                 Case[]
  aiAnalyses            AIAnalysis[]

  @@index([email, isActive], map: "idx_user_login")
  @@index([khcAdvocateId, isActive], map: "idx_user_khc")
  @@map("users")
}

enum UserRole {
  ADVOCATE @map("advocate")
  ADMIN    @map("admin")

  @@map("user_role")
}

// ============================================
// CASE MANAGEMENT
// ============================================

model Case {
  id                  String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  advocateId          String         @map("advocate_id") @db.Uuid
  caseNumber          String?        @map("case_number") @db.VarChar(100)
  efilingNumber       String         @unique @map("efiling_number") @db.VarChar(100)
  caseType            String         @map("case_type") @db.VarChar(50)
  caseYear            Int            @map("case_year")
  partyRole           CasePartyRole  @map("party_role")
  petitionerName      String         @map("petitioner_name") @db.Text
  respondentName      String         @map("respondent_name") @db.Text
  efilingDate         DateTime       @map("efiling_date")
  efilingDetails      String?        @map("efiling_details") @db.Text
  benchType           String?        @map("bench_type") @db.VarChar(50)
  judgeName           String?        @map("judge_name") @db.VarChar(255)
  courtNumber         String?        @map("court_number") @db.VarChar(50)
  status              CaseStatus     @default(FILED)
  nextHearingDate     DateTime?      @map("next_hearing_date")
  khcSourceUrl        String?        @map("khc_source_url") @db.Text
  lastSyncedAt        DateTime?      @map("last_synced_at")
  syncStatus          String         @default("pending") @map("sync_status") @db.VarChar(50)
  searchVector        String?        @map("search_vector") // Using String for TSVECTOR
  isVisible           Boolean        @default(true) @map("is_visible")
  transferredReason   String?        @map("transferred_reason") @db.Text
  transferredAt       DateTime?      @map("transferred_at")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @default(now()) @updatedAt @map("updated_at")

  advocate            User           @relation(fields: [advocateId], references: [id], onDelete: Cascade)
  documents           Document[]
  history             CaseHistory[]
  aiAnalysis          AIAnalysis?
  hearingBriefs       HearingBrief[]

  @@index([advocateId, status, isVisible], map: "idx_case_advocate_status")
  @@index([advocateId, nextHearingDate], map: "idx_case_advocate_hearing")
  @@map("cases")
}

enum CaseStatus {
  FILED        @map("filed")
  REGISTERED   @map("registered")
  PENDING      @map("pending")
  DISPOSED     @map("disposed")
  TRANSFERRED  @map("transferred")

  @@map("case_status")
}

enum CasePartyRole {
  PETITIONER  @map("petitioner")
  RESPONDENT  @map("respondent")
  APPELLANT   @map("appellant")
  DEFENDANT   @map("defendant")

  @@map("case_party_role")
}

// ============================================
// DOCUMENT MANAGEMENT
// ============================================

model Document {
  id                String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  caseId            String           @map("case_id") @db.Uuid
  khcDocumentId     String           @map("khc_document_id") @db.VarChar(100)
  category          DocumentCategory
  title             String           @db.VarChar(255)
  description       String?          @db.Text
  s3Key             String           @unique @map("s3_key") @db.VarChar(500)
  s3Bucket          String           @default("lawmate-case-pdfs") @map("s3_bucket") @db.VarChar(100)
  s3VersionId       String?          @map("s3_version_id") @db.VarChar(100)
  fileSize          BigInt           @map("file_size")
  contentType       String           @default("application/pdf") @map("content_type") @db.VarChar(50)
  checksumMd5       String?          @map("checksum_md5") @db.VarChar(32)
  uploadStatus      UploadStatus     @default(PENDING) @map("upload_status")
  uploadedAt        DateTime?        @map("uploaded_at")
  uploadError       String?          @map("upload_error") @db.Text
  sourceUrl         String?          @map("source_url") @db.Text
  isOcrRequired     Boolean          @default(false) @map("is_ocr_required")
  ocrStatus         OcrStatus        @default(NOT_REQUIRED) @map("ocr_status")
  ocrJobId          String?          @map("ocr_job_id") @db.VarChar(255)
  
  // AI Classification Fields
  extractedText     String?          @map("extracted_text") @db.Text
  classificationConfidence Float?    @map("classification_confidence")
  aiMetadata        Json?            @map("ai_metadata") @db.JsonB
  
  isLocked          Boolean          @default(false) @map("is_locked")
  lockReason        String?          @map("lock_reason") @db.VarChar(255)
  lockedAt          DateTime?        @map("locked_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @default(now()) @updatedAt @map("updated_at")

  case              Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  orders            CaseHistory[]

  @@index([caseId, category], map: "idx_doc_case_category")
  @@map("documents")
}

enum DocumentCategory {
  CASE_FILE  @map("case_file")
  ANNEXURE   @map("annexure")
  JUDGMENT   @map("judgment")
  ORDER      @map("order")
  MISC       @map("misc")

  @@map("document_category")
}

enum UploadStatus {
  PENDING    @map("pending")
  UPLOADING  @map("uploading")
  COMPLETED  @map("completed")
  FAILED     @map("failed")

  @@map("upload_status")
}

enum OcrStatus {
  NOT_REQUIRED @map("not_required")
  PENDING      @map("pending")
  PROCESSING   @map("processing")
  COMPLETED    @map("completed")
  FAILED       @map("failed")

  @@map("ocr_status")
}

// ============================================
// CASE HISTORY
// ============================================

model CaseHistory {
  id               String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  caseId           String        @map("case_id") @db.Uuid
  eventType        CaseEventType @map("event_type")
  eventDate        DateTime      @map("event_date")
  businessRecorded String        @map("business_recorded") @db.Text
  judgeName        String?       @map("judge_name") @db.VarChar(255)
  benchType        String?       @map("bench_type") @db.VarChar(50)
  courtNumber      String?       @map("court_number") @db.VarChar(50)
  nextHearingDate  DateTime?     @map("next_hearing_date")
  orderDocumentId  String?       @map("order_document_id") @db.Uuid
  createdAt        DateTime      @default(now()) @map("created_at")

  case             Case          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  orderDocument    Document?     @relation(fields: [orderDocumentId], references: [id])

  @@index([caseId, eventDate], map: "idx_history_case_date")
  @@map("case_history")
}

enum CaseEventType {
  HEARING @map("hearing")
  ORDER   @map("order")
  JUDGMENT @map("judgment")
  FILING  @map("filing")
  NOTICE  @map("notice")

  @@map("case_event_type")
}

// ============================================
// AI ANALYSIS SYSTEM (LEGACY)
// ============================================

model AIAnalysis {
  id                    String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  caseId                String              @unique @map("case_id") @db.Uuid
  advocateId            String              @map("advocate_id") @db.Uuid
  status                AIAnalysisStatus    @default(PENDING)
  modelVersion          String              @default("claude-3.5-sonnet") @map("model_version") @db.VarChar(50)
  analysis              Json?               @db.JsonB
  urgencyLevel          UrgencyLevel?       @map("urgency_level")
  caseSummary           String?             @map("case_summary") @db.Text
  processedAt           DateTime?           @map("processed_at")
  processingTimeSeconds Int?                @map("processing_time_seconds")
  tokenCount            Int?                @map("token_count")
  errorMessage          String?             @map("error_message") @db.Text
  retryCount            Int                 @default(0) @map("retry_count")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @default(now()) @updatedAt @map("updated_at")

  case                  Case                @relation(fields: [caseId], references: [id], onDelete: Cascade)
  advocate              User                @relation(fields: [advocateId], references: [id], onDelete: Cascade)

  @@index([advocateId, urgencyLevel], map: "idx_ai_advocate_urgency")
  @@map("ai_analyses")
}

enum AIAnalysisStatus {
  PENDING    @map("pending")
  PROCESSING @map("processing")
  COMPLETED  @map("completed")
  FAILED     @map("failed")

  @@map("ai_analysis_status")
}

enum UrgencyLevel {
  LOW      @map("low")
  MEDIUM   @map("medium")
  HIGH     @map("high")
  CRITICAL @map("critical")

  @@map("urgency_level")
}

// ============================================
// NEW AI FEATURES - MODULAR ANALYSIS
// ============================================

model AIInsight {
  id            String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  caseId        String            @map("case_id") @db.Uuid
  insightType   AIInsightType     @map("insight_type")
  result        Json              @db.JsonB
  
  // Model info
  model         String            @default("claude-3-5-sonnet-20241022")
  tokensUsed    Int?              @map("tokens_used")
  
  // Status
  status        InsightStatus     @default(COMPLETED)
  error         String?           @db.Text
  
  // Cache info
  cached        Boolean           @default(false)
  cacheKey      String?           @map("cache_key") @db.VarChar(255)
  
  createdAt     DateTime          @default(now()) @map("created_at")
  expiresAt     DateTime?         @map("expires_at")

  @@index([caseId, insightType], map: "idx_insight_case_type")
  @@index([cacheKey], map: "idx_insight_cache")
  @@map("ai_insights")
}

enum AIInsightType {
  BUNDLE_ANALYSIS      @map("bundle_analysis")
  PRECEDENTS           @map("precedents")
  RISK_ASSESSMENT      @map("risk_assessment")
  RIGHTS_MAPPING       @map("rights_mapping")
  NARRATIVE            @map("narrative")
  COUNTER_ANTICIPATION @map("counter_anticipation")
  RELIEF_EVALUATION    @map("relief_evaluation")

  @@map("ai_insight_type")
}

enum InsightStatus {
  PENDING    @map("pending")
  PROCESSING @map("processing")
  COMPLETED  @map("completed")
  FAILED     @map("failed")

  @@map("insight_status")
}

// ============================================
// HEARING BRIEFS
// ============================================

model HearingBrief {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  caseId          String    @map("case_id") @db.Uuid
  hearingDate     DateTime  @map("hearing_date")
  content         String    @db.Text
  focusAreas      String[]  @map("focus_areas")
  
  // Generated from analyses
  bundleSnapshot  Json?     @map("bundle_snapshot") @db.JsonB
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  case            Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, hearingDate], map: "idx_brief_case_hearing")
  @@map("hearing_briefs")
}